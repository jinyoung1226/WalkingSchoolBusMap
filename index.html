<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>워킹스쿨버스 운행 지도</title>
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=783823781317f359b71a726bd9318357"
    ></script>
  </head>
  <body>
    <div id="map" style="width: 100%; height: 700px"></div>

    <script>
      var map, guideMarkerEl, guideMarkerOverlay;
      var isMapInitialized = false;
    
      function getParamsFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const waypointsParam = params.get("waypoints");
        const initialLocationParam = params.get("initialLocation");
    
        try {
          const waypoints = JSON.parse(decodeURIComponent(waypointsParam));
          const initialLocation = JSON.parse(decodeURIComponent(initialLocationParam));
          return { waypoints, initialLocation };
        } catch (error) {
          console.error("경유지 또는 초기 위치 데이터를 파싱하는 중 오류 발생:", error);
          return { waypoints: [], initialLocation: { latitude: 37.277, longitude: 127.038 } };
        }
      }
    
      function initializeMap(initialPosition, waypoints) {
        map = new kakao.maps.Map(document.getElementById("map"), {
          center: initialPosition,
          level: 4,
        });
    
        waypoints.forEach(function (waypoint, index) {
          const isLastWaypoint = index === waypoints.length - 1;
          const markerImageSrc = isLastWaypoint
            ? "./icon/destination.png"
            : "./icon/waypointInStudent.png";
          const markerImageSize = isLastWaypoint
            ? new kakao.maps.Size(31, 37)
            : new kakao.maps.Size(37.24, 46);
    
          new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(waypoint.latitude, waypoint.longitude),
            title: waypoint.waypointName,
            image: new kakao.maps.MarkerImage(markerImageSrc, markerImageSize),
          });
        });
    
        // 가이드 마커를 HTML 엘리먼트로 생성
        guideMarkerEl = document.createElement("div");
        guideMarkerEl.style.width = "40px";
        guideMarkerEl.style.height = "40px";
        guideMarkerEl.style.backgroundImage = "url('./icon/guideMarker.png')";
        guideMarkerEl.style.backgroundSize = "cover";
        guideMarkerEl.style.transformOrigin = "center";
        guideMarkerEl.style.transition = "transform 0.1s linear";
    
        guideMarkerOverlay = new kakao.maps.CustomOverlay({
          map: map,
          position: initialPosition,
          content: guideMarkerEl,
          yAnchor: 0.5,
          xAnchor: 0.5,
        });
      }
    
      function updateGuidePosition(newLat, newLng) {
        const newPosition = new kakao.maps.LatLng(newLat, newLng);
        guideMarkerOverlay.setPosition(newPosition);
        map.setCenter(newPosition);
      }
    
      function updateGuideRotation(rotation) {
        guideMarkerEl.style.transform = `rotate(${rotation}deg)`;
      }
    
      const { waypoints, initialLocation } = getParamsFromQuery();
      const initialPosition = new kakao.maps.LatLng(initialLocation.latitude, initialLocation.longitude);
    
      initializeMap(initialPosition, waypoints);
    
      window.addEventListener("message", function (event) {
        try {
            const data = JSON.parse(event.data);
            
            if (data.latitude !== undefined && data.longitude !== undefined) {
                updateGuidePosition(data.latitude, data.longitude);
                console.log("인솔자 위치 업데이트:", data.latitude, data.longitude);
            }
            
            if (data.rotation !== undefined) {
                updateGuideRotation(data.rotation);
                console.log("마커 회전 업데이트:", data.rotation);
            }
            
        } catch (error) {
            console.error("메시지 처리 중 오류 발생:", error);
        }
      });
    </script>
  </body>
</html>

