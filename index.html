<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>워킹스쿨버스 운행 지도</title>
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=783823781317f359b71a726bd9318357"
    ></script>
  </head>
  <body>
    <div id="map" style="width: 100%; height: 700px"></div>

    <script>
      var map, guideMarker;

      // URL의 쿼리 파라미터에서 경유지 데이터를 가져오는 함수
      function getWaypointsFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const waypointsParam = params.get("waypoints");

        try {
          return JSON.parse(decodeURIComponent(waypointsParam));
        } catch (error) {
          console.error("경유지 데이터를 파싱하는 중 오류 발생:", error);
          return [];
        }
      }

      // 지도 초기화 함수
      function initializeMap(waypoints) {
        // 최초 인솔자 위치가 없을 경우 사용할 기본 위치
        var initialPosition = new kakao.maps.LatLng(37.277, 127.038);

        // 지도 생성
        map = new kakao.maps.Map(document.getElementById("map"), {
          center: initialPosition,
          level: 2,
        });

        // 경유지 마커 표시
        waypoints.forEach(function (waypoint) {
          new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(
              waypoint.latitude,
              waypoint.longitude
            ),
            title: waypoint.waypointName,
            image: new kakao.maps.MarkerImage(
              "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
              new kakao.maps.Size(24, 35)
            ),
          });
        });

        // 인솔자 위치 표시 마커 (초기 위치는 기본값)
        guideMarker = new kakao.maps.Marker({
          map: map,
          position: initialPosition,
          title: "인솔자 위치",
          image: new kakao.maps.MarkerImage(
            "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
            new kakao.maps.Size(24, 35)
          ),
        });
      }

      // 인솔자 위치 갱신 함수
      function updateGuidePosition(newLat, newLng) {
        var newPosition = new kakao.maps.LatLng(newLat, newLng);
        guideMarker.setPosition(newPosition); // 인솔자 마커 위치 갱신
        map.setCenter(newPosition); // 지도 중심 갱신
      }

      // 경유지 데이터를 URL 파라미터에서 가져옴
      var waypoints = getWaypointsFromQuery();

      // 지도 초기화
      initializeMap(waypoints);

      // React Native에서 인솔자 위치 수신
      window.addEventListener("message", function (event) {
        const data = JSON.parse(event.data);
        updateGuidePosition(data.latitude, data.longitude); // 인솔자 위치 갱신
        console.log(data.latitude, data.longitude);
      });
    </script>
  </body>
</html>
